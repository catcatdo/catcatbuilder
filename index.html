<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>오늘의 개발자 뉴스</title>
  <meta name="description" content="오늘의 개발자 뉴스 - 해커뉴스 스타일 타임라인과 커뮤니티 핫 토픽 큐레이션">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f3f4ef;
      --surface: #ffffff;
      --text: #111111;
      --muted: #5e5e5e;
      --line: #d8d8cf;
      --accent: #d35400;
      --accent-soft: #fff1e5;
      --chip: #f1f1ec;
      --shadow: 0 12px 28px rgba(16, 16, 16, 0.06);
      --max: 1080px;
      --radius: 14px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Space Grotesk", "Apple SD Gothic Neo", "Noto Sans KR", sans-serif;
      color: var(--text);
      background: radial-gradient(circle at 15% 0%, #f7f7f2 0%, var(--bg) 38%, #eeefe8 100%);
      line-height: 1.45;
    }

    a { color: inherit; }

    .wrap {
      max-width: var(--max);
      margin: 0 auto;
      padding: 24px 16px 84px;
    }

    .hero {
      border: 1px solid var(--line);
      background: linear-gradient(145deg, #fffefa, #ffffff);
      border-radius: var(--radius);
      padding: 22px;
      box-shadow: var(--shadow);
      margin-bottom: 16px;
    }

    .hero h1 {
      margin: 0;
      font-size: clamp(1.8rem, 4vw, 2.7rem);
      letter-spacing: -0.03em;
    }

    .hero p {
      margin: 10px 0 0;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .top-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-bottom: 18px;
    }

    .topic-box {
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: var(--surface);
      padding: 16px;
    }

    .topic-box h2 {
      margin: 0 0 12px;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .cards {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }

    .card {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 11px;
      background: #fcfcfa;
      text-decoration: none;
    }

    .card .meta {
      color: var(--muted);
      font-size: 0.77rem;
      margin-bottom: 5px;
    }

    .card .title {
      font-size: 0.92rem;
      margin: 0;
      line-height: 1.35;
    }

    .filters {
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: var(--surface);
      padding: 14px;
      margin-bottom: 14px;
      position: sticky;
      top: 10px;
      z-index: 15;
    }

    .filter-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 9px;
      font-size: 0.87rem;
      color: var(--muted);
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip {
      border: 1px solid var(--line);
      background: var(--chip);
      color: #2b2b2b;
      border-radius: 999px;
      padding: 6px 12px;
      font: inherit;
      font-size: 0.82rem;
      cursor: pointer;
    }

    .chip.active {
      background: var(--accent-soft);
      border-color: #efbe97;
      color: #8d3200;
      font-weight: 600;
    }

    .timeline {
      list-style: none;
      margin: 0;
      padding: 0;
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: var(--surface);
      overflow: hidden;
    }

    .item {
      display: grid;
      grid-template-columns: 44px 1fr;
      gap: 10px;
      padding: 13px;
      border-top: 1px solid #ecece6;
    }

    .item:first-child { border-top: 0; }

    .rank {
      color: #9a9a92;
      font-size: 0.86rem;
      text-align: right;
      padding-top: 2px;
    }

    .title-row {
      display: flex;
      gap: 8px;
      align-items: flex-start;
      flex-wrap: wrap;
    }

    .news-title {
      font-size: 1rem;
      text-decoration: none;
      color: #1f1f1f;
    }

    .news-title:hover { color: var(--accent); }

    .source {
      font-size: 0.76rem;
      color: var(--muted);
      border: 1px solid var(--line);
      background: #f8f8f4;
      border-radius: 999px;
      padding: 2px 8px;
      white-space: nowrap;
    }

    .summary {
      margin: 7px 0 10px;
      color: #3b3b3b;
      font-size: 0.9rem;
    }

    .meta-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px 10px;
      color: var(--muted);
      font-size: 0.8rem;
    }

    .tag {
      border: 1px solid #ebd2bf;
      background: #fff8f2;
      color: #8d3200;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.75rem;
    }

    .controls {
      margin-top: 9px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      border: 1px solid var(--line);
      border-radius: 8px;
      background: #fafaf7;
      color: #252525;
      font: inherit;
      font-size: 0.8rem;
      padding: 6px 10px;
      cursor: pointer;
    }

    .btn:hover { background: #f3f3ee; }

    .vote-count {
      font-weight: 700;
      color: #7f2d00;
    }

    .newsletter {
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, #fffefb, #fff);
      padding: 18px;
      margin-top: 18px;
      box-shadow: var(--shadow);
    }

    .newsletter h3 {
      margin: 0 0 8px;
      font-size: 1.12rem;
    }

    .newsletter p {
      margin: 0 0 12px;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
    }

    input[type="email"] {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 11px;
      font: inherit;
      background: #fff;
    }

    .submit {
      border: 1px solid #cb8c63;
      background: var(--accent);
      color: #fff;
      border-radius: 10px;
      padding: 0 16px;
      font: inherit;
      cursor: pointer;
      min-height: 42px;
    }

    .status {
      min-height: 18px;
      margin-top: 8px;
      color: var(--muted);
      font-size: 0.82rem;
    }

    .end-marker,
    .loading {
      text-align: center;
      color: var(--muted);
      font-size: 0.82rem;
      padding: 12px;
    }

    @media (min-width: 860px) {
      .top-grid {
        grid-template-columns: 1fr 1fr;
      }

      .cards {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 600px) {
      .item {
        grid-template-columns: 32px 1fr;
      }

      .rank {
        font-size: 0.78rem;
      }

      .form-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="hero">
      <h1>오늘의 개발자 뉴스</h1>
      <p>해커뉴스 스타일 타임라인으로 핵심 이슈를 빠르게 훑고, Reddit/디시인사이드 핫 토픽까지 한 번에 확인하세요.</p>
    </section>

    <section class="top-grid" aria-label="핫 토픽">
      <article class="topic-box">
        <h2>Reddit 핫 토픽</h2>
        <div class="cards" id="redditCards"></div>
      </article>
      <article class="topic-box">
        <h2>디시인사이드 핫 토픽</h2>
        <div class="cards" id="dcCards"></div>
      </article>
    </section>

    <section class="filters" aria-label="태그 필터">
      <div class="filter-head">
        <span>태그 필터</span>
        <strong id="resultCount">0개</strong>
      </div>
      <div class="chips" id="tagFilters"></div>
    </section>

    <ol class="timeline" id="timeline"></ol>
    <div class="loading" id="loading">불러오는 중...</div>
    <div class="end-marker" id="endMarker" hidden>모든 뉴스를 확인했습니다.</div>
    <div id="sentinel" aria-hidden="true"></div>

    <section class="newsletter" aria-label="주간 뉴스레터 구독">
      <h3>주간 개발자 뉴스레터</h3>
      <p>매주 금요일, 한 주의 기술 이슈를 요약해서 보내드립니다.</p>
      <form id="newsletterForm" novalidate>
        <div class="form-row">
          <input id="newsletterEmail" type="email" placeholder="you@example.com" required>
          <button type="submit" class="submit">구독하기</button>
        </div>
        <div class="status" id="newsletterStatus"></div>
      </form>
    </section>
  </main>

  <script>
    const PAGE_SIZE = 8;
    const FALLBACK_TAGS = ["Docker", "GitHub", "AI", "Backend", "Frontend", "DevOps", "Security", "Cloud"];
    const state = {
      allPosts: [],
      filteredPosts: [],
      hotTopics: { reddit: [], dcinside: [] },
      visibleCount: 0,
      activeTag: "ALL",
      loading: false,
      votes: JSON.parse(localStorage.getItem("newsVotes") || "{}"),
      voted: JSON.parse(localStorage.getItem("newsVoted") || "{}")
    };

    const timelineEl = document.getElementById("timeline");
    const loadingEl = document.getElementById("loading");
    const endMarkerEl = document.getElementById("endMarker");
    const resultCountEl = document.getElementById("resultCount");
    const tagFiltersEl = document.getElementById("tagFilters");

    function escapeHtml(value) {
      return String(value)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    function formatTimeAgo(iso) {
      const diffMin = Math.floor((Date.now() - new Date(iso).getTime()) / 60000);
      if (diffMin < 60) return `${Math.max(diffMin, 1)}분 전`;
      if (diffMin < 1440) return `${Math.floor(diffMin / 60)}시간 전`;
      return `${Math.floor(diffMin / 1440)}일 전`;
    }

    function mapSourceLabel(source) {
      const labels = {
        hn: "Hacker News",
        reddit: "Reddit",
        dcinside: "DC Inside",
        github: "GitHub"
      };
      return labels[source] || source;
    }

    function buildCard(topic) {
      return `
        <a class="card" href="${escapeHtml(topic.url)}" target="_blank" rel="noopener noreferrer">
          <div class="meta">${escapeHtml(topic.community)} · ${escapeHtml(topic.metric)}</div>
          <p class="title">${escapeHtml(topic.title)}</p>
        </a>
      `;
    }

    function renderHotCards() {
      const redditRoot = document.getElementById("redditCards");
      const dcRoot = document.getElementById("dcCards");
      redditRoot.innerHTML = state.hotTopics.reddit.map(buildCard).join("");
      dcRoot.innerHTML = state.hotTopics.dcinside.map(buildCard).join("");
    }

    function renderFilters() {
      const tags = new Set(FALLBACK_TAGS);
      state.allPosts.forEach((post) => (post.tags || []).forEach((tag) => tags.add(tag)));
      const order = ["ALL", ...Array.from(tags)];
      tagFiltersEl.innerHTML = order
        .map((tag) => `<button class="chip ${tag === state.activeTag ? "active" : ""}" data-tag="${escapeHtml(tag)}">${escapeHtml(tag)}</button>`)
        .join("");

      tagFiltersEl.querySelectorAll(".chip").forEach((chip) => {
        chip.addEventListener("click", () => {
          state.activeTag = chip.dataset.tag;
          applyFilter();
        });
      });
    }

    function applyFilter() {
      state.filteredPosts = state.activeTag === "ALL"
        ? [...state.allPosts]
        : state.allPosts.filter((post) => (post.tags || []).includes(state.activeTag));

      state.visibleCount = 0;
      timelineEl.innerHTML = "";
      renderFilters();
      updateResultCount();
      appendNextPage();
    }

    function updateResultCount() {
      resultCountEl.textContent = `${state.filteredPosts.length}개`;
    }

    function getVoteCount(post) {
      const base = Number(post.votes || 0);
      const delta = Number(state.votes[post.id] || 0);
      return base + delta;
    }

    function renderPost(post, index) {
      const tag = (post.tags && post.tags[0]) || "General";
      const voted = Boolean(state.voted[post.id]);
      return `
        <li class="item" data-id="${escapeHtml(post.id)}">
          <div class="rank">${index + 1}.</div>
          <div>
            <div class="title-row">
              <a class="news-title" href="${escapeHtml(post.url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(post.title)}</a>
              <span class="source">${escapeHtml(mapSourceLabel(post.source))}</span>
            </div>
            <p class="summary">${escapeHtml(post.summary || "")}</p>
            <div class="meta-row">
              <span>${getVoteCount(post)} points</span>
              <span>${escapeHtml(String(post.comments || 0))} comments</span>
              <span>${escapeHtml(post.author || "unknown")}</span>
              <span>${formatTimeAgo(post.publishedAt)}</span>
              <span class="tag">${escapeHtml(tag)}</span>
            </div>
            <div class="controls">
              <button class="btn vote-btn" data-id="${escapeHtml(post.id)}" ${voted ? "disabled" : ""}>
                ▲ 투표 <span class="vote-count">${getVoteCount(post)}</span>
              </button>
              <button class="btn share-btn" data-title="${escapeHtml(post.title)}" data-url="${escapeHtml(post.url)}">공유</button>
            </div>
          </div>
        </li>
      `;
    }

    function appendNextPage() {
      if (state.loading) return;
      const start = state.visibleCount;
      const end = start + PAGE_SIZE;
      const nextItems = state.filteredPosts.slice(start, end);

      if (!nextItems.length) {
        loadingEl.hidden = true;
        endMarkerEl.hidden = state.filteredPosts.length === 0 ? false : start !== state.filteredPosts.length;
        if (state.filteredPosts.length === 0) {
          endMarkerEl.textContent = "조건에 맞는 뉴스가 없습니다.";
          endMarkerEl.hidden = false;
        } else {
          endMarkerEl.textContent = "모든 뉴스를 확인했습니다.";
          endMarkerEl.hidden = false;
        }
        return;
      }

      loadingEl.hidden = false;
      endMarkerEl.hidden = true;
      const chunk = nextItems.map((post, idx) => renderPost(post, start + idx)).join("");
      timelineEl.insertAdjacentHTML("beforeend", chunk);
      state.visibleCount = end;
      wireItemActions();

      if (state.visibleCount >= state.filteredPosts.length) {
        loadingEl.hidden = true;
        endMarkerEl.hidden = false;
      }
    }

    function wireItemActions() {
      document.querySelectorAll(".vote-btn").forEach((button) => {
        if (button.dataset.bound === "1") return;
        button.dataset.bound = "1";

        button.addEventListener("click", () => {
          const id = button.dataset.id;
          if (state.voted[id]) return;

          state.votes[id] = Number(state.votes[id] || 0) + 1;
          state.voted[id] = true;
          localStorage.setItem("newsVotes", JSON.stringify(state.votes));
          localStorage.setItem("newsVoted", JSON.stringify(state.voted));

          const countEl = button.querySelector(".vote-count");
          const post = state.allPosts.find((item) => item.id === id);
          if (countEl && post) {
            countEl.textContent = getVoteCount(post);
          }
          button.disabled = true;
        });
      });

      document.querySelectorAll(".share-btn").forEach((button) => {
        if (button.dataset.bound === "1") return;
        button.dataset.bound = "1";

        button.addEventListener("click", async () => {
          const title = button.dataset.title;
          const url = button.dataset.url;

          try {
            if (navigator.share) {
              await navigator.share({ title, url });
            } else if (navigator.clipboard?.writeText) {
              await navigator.clipboard.writeText(url);
              button.textContent = "복사됨";
              setTimeout(() => { button.textContent = "공유"; }, 1200);
            } else {
              window.prompt("URL 복사", url);
            }
          } catch (_) {
            // User canceled sharing.
          }
        });
      });
    }

    function setupInfiniteScroll() {
      const sentinel = document.getElementById("sentinel");
      const observer = new IntersectionObserver((entries) => {
        if (entries[0]?.isIntersecting) appendNextPage();
      }, { rootMargin: "300px 0px" });
      observer.observe(sentinel);
    }

    function setupNewsletter() {
      const form = document.getElementById("newsletterForm");
      const input = document.getElementById("newsletterEmail");
      const status = document.getElementById("newsletterStatus");

      form.addEventListener("submit", (event) => {
        event.preventDefault();
        const email = input.value.trim();
        if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          status.textContent = "유효한 이메일 주소를 입력해 주세요.";
          return;
        }

        const saved = JSON.parse(localStorage.getItem("newsletterSubscribers") || "[]");
        if (!saved.includes(email)) {
          saved.push(email);
          localStorage.setItem("newsletterSubscribers", JSON.stringify(saved));
        }

        status.textContent = "구독 완료! 이번 주 금요일 오전에 뉴스레터를 발송합니다.";
        form.reset();
      });
    }

    async function boot() {
      try {
        const response = await fetch("/api/posts.json", { cache: "no-store" });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        state.allPosts = (data.posts || []).sort((a, b) => new Date(b.publishedAt) - new Date(a.publishedAt));
        state.hotTopics = data.hotTopics || state.hotTopics;
      } catch (error) {
        console.error("failed to load posts", error);
        state.allPosts = [];
      }

      renderHotCards();
      renderFilters();
      applyFilter();
      setupInfiniteScroll();
      setupNewsletter();
    }

    boot();
  </script>
</body>
</html>
